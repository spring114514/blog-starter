import { r, a, o, f, i as i$1, b as b$2 } from './chunk-CYWDPOFS.js';
import { i, q, x as x$1, u as u$1, b as b$1 } from './chunk-CNNNR7MI.js';
import { s, b, H, P, E, o as o$1, u as u$2, ha } from './chunk-QIQY7YWJ.js';

var x=Symbol(0),S=Symbol(0);var V=r=>ha(r),u=class{constructor(e){this.se=e;this.ae=null;this.Rr=null;this.Hr={};this.Dr=new Set;}get instance(){return this.ae}setup(e,t){this.ee=t;let i=b(t.$store.streamType).includes("live"),d=b(t.$store.streamType).includes("ll-");this.ae=new e({lowLatencyMode:d,backBufferLength:d?4:i?8:void 0,renderTextTracksNatively:!1,...this.Hr});let o=this.zn.bind(this);for(let s of Object.values(e.Events))this.ae.on(s,o);this.ae.on(e.Events.ERROR,this.it.bind(this));for(let s of this.Dr)s(this.ae);t.player.dispatchEvent(new H("hls-instance",{detail:this.ae})),this.ae.attachMedia(this.se),this.ae.on(e.Events.AUDIO_TRACK_SWITCHED,this.Xn.bind(this)),this.ae.on(e.Events.LEVEL_SWITCHED,this.Yn.bind(this)),this.ae.on(e.Events.LEVEL_LOADED,this.Jn.bind(this)),this.ae.on(e.Events.NON_NATIVE_TEXT_TRACKS_FOUND,this.es.bind(this)),this.ae.on(e.Events.CUES_PARSED,this.ts.bind(this)),t.qualities[S]=this.rs.bind(this),P(t.qualities,"change",this.Or.bind(this)),P(t.audioTracks,"change",this.is.bind(this)),this.Rr=E(this.os.bind(this));}os(){if(!this.ee.$store.live())return;let e=new q(this.ns.bind(this));return e.or(),e.Je.bind(e)}ns(){this.ee.$store.liveSyncPosition.set(this.ae?.liveSyncPosition??1/0);}zn(e,t){this.ee.player.dispatchEvent(new H(V(e),{detail:t}));}es(e,t){let i=new H(e,{detail:t}),d=-1;for(let o$1=0;o$1<t.tracks.length;o$1++){let s=t.tracks[o$1],h=s.subtitleTrack??s.closedCaptions,n=new o({id:`hls-${s.kind}${o$1}`,src:h?.url,label:s.label,language:h?.lang,kind:s.kind});n[f]=2,n[i$1]=()=>{n.mode==="showing"?(this.ae.subtitleTrack=o$1,d=o$1):d===o$1&&(this.ae.subtitleTrack=-1,d=-1);},s.default&&n.setMode("showing",i),this.ee.textTracks.add(n,i);}}ts(e,t){let i=this.ee.textTracks.getById(`hls-${t.track}`);if(!i)return;let d=new H(e,{detail:t});for(let o of t.cues)o.positionAlign="auto",i.addCue(o,d);}Xn(e,t){let i=this.ee.audioTracks[t.id];i&&this.ee.audioTracks[x$1](i,!0,new H(e,{detail:t}));}Yn(e,t){let i=this.ee.qualities[t.level];i&&this.ee.qualities[x$1](i,!0,new H(e,{detail:t}));}Jn(e,t){if(this.ee.$store.canPlay())return;let{type:i,live:d,totalduration:o}=t.details,s=new H(e,{detail:t});this.ee.delegate.te("stream-type-change",{detail:d?i==="EVENT"&&Number.isFinite(o)?"live:dvr":"live":"on-demand",trigger:s}),this.ee.delegate.te("duration-change",{detail:o,trigger:s});let h=this.ae.media;this.ae.currentLevel===-1&&this.ee.qualities[x](!0,s);for(let n of this.ae.audioTracks)this.ee.audioTracks[u$1]({id:n.id+"",label:n.name,language:n.lang||"",kind:"main"},s);for(let n of this.ae.levels)this.ee.qualities[u$1]({width:n.width,height:n.height,codec:n.codecSet,bitrate:n.bitrate},s);h.dispatchEvent(new H("canplay",{trigger:s}));}it(e,t){if(t.fatal)switch(t.type){case"networkError":this.ae?.startLoad();break;case"mediaError":this.ae?.recoverMediaError();break;default:this.ae?.destroy(),this.ae=null;break}}rs(){this.ae&&(this.ae.currentLevel=-1);}Or(){let{qualities:e}=this.ee;!this.ae||e.auto||(this.ae[e.switch+"Level"]=e.selectedIndex,b$1&&(this.se.currentTime=this.se.currentTime));}is(){let{audioTracks:e}=this.ee;this.ae&&this.ae.audioTrack!==e.selectedIndex&&(this.ae.audioTrack=e.selectedIndex);}Nr(){this.ee&&(this.ee.qualities[S]=void 0),this.ae?.destroy(),this.ae=null,this.Rr?.(),this.Rr=null;}};function M(r){return r instanceof Error?r:Error(JSON.stringify(r))}var p=class{constructor(e,t,i){this.qr=e;this.ee=t;this.et=i;this.ss();}async ss(){let e={onLoadStart:this.tt.bind(this),onLoaded:this.Fr.bind(this),onLoadError:this.as.bind(this)},t=await N(this.qr,e);if(o$1(t)&&!s(this.qr)&&(t=await O(this.qr,e)),!t)return null;if(!t.isSupported()){let i="[vidstack]: `hls.js` is not supported in this environment";return this.ee.player.dispatchEvent(new H("hls-unsupported")),this.ee.delegate.te("error",{detail:{message:i,code:4}}),null}return t}tt(){this.ee.player.dispatchEvent(new H("hls-lib-load-start"));}Fr(e){this.ee.player.dispatchEvent(new H("hls-lib-loaded",{detail:e})),this.et(e);}as(e){let t=M(e);this.ee.player.dispatchEvent(new H("hls-lib-load-error",{detail:t})),this.ee.delegate.te("error",{detail:{message:t.message,code:4}});}};async function O(r,e={}){if(!o$1(r)){if(e.onLoadStart?.(),r.prototype&&r.prototype!==Function)return e.onLoaded?.(r),r;try{let t=(await r())?.default;if(t&&t.isSupported)e.onLoaded?.(t);else throw Error("");return t}catch(t){e.onLoadError?.(t);}}}async function N(r,e={}){if(s(r)){e.onLoadStart?.();try{if(await b$2(r),!u$2(window.Hls))throw Error("");let t=window.Hls;return e.onLoaded?.(t),t}catch(t){e.onLoadError?.(t);}}}var R=Symbol(0),U="https://cdn.jsdelivr.net",$,m=class extends r{constructor(){super(...arguments);this[$]=!0;this.co=null;this.xe=new u(this.video);this.Nt=`${U}/npm/hls.js@^1.0.0/dist/hls.min.js`;}get ctor(){return this.co}get instance(){return this.xe.instance}get type(){return "hls"}get canLiveSync(){return !0}get config(){return this.xe.Hr}set config(t){this.xe.Hr=t;}get library(){return this.Nt}set library(t){this.Nt=t;}preconnect(){s(this.Nt)&&a(this.Nt);}setup(t){super.setup(t),new p(this.Nt,t,i=>{this.co=i,this.xe.setup(i,t),t.delegate.te("provider-setup",{detail:this});let d=b(t.$store.source);d&&this.loadSource(d);});}async loadSource({src:t}){s(t)&&this.xe.instance?.loadSource(t);}onInstance(t){let i=this.xe.instance;return i&&t(i),this.xe.Dr.add(t),()=>this.xe.Dr.delete(t)}destroy(){this.xe.Nr();}};$=R,m.supported=i();

export { x as a, S as b, M as c, R as d, m as e };
